<div id="table-wrap" class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Категории ({{ ym }})</div>
      <div class="text-secondary small">
        План: <b>{{ "%.0f"|format(summary.total_plan) }}</b> ₽ ·
        Факт: <b>{{ "%.0f"|format(summary.total_minus) }}</b> ₽ ·
        Остаток: <b>{{ "%.0f"|format(summary.total_left) }}</b> ₽
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-dark">
          <tr>
            <th>Категория</th>
            <th>Источник</th>  <!-- NEW -->
            <th>₽ фикс</th>
            <th>%</th>
            <th>План</th>
            <th>Потрачено</th>
            <th>Остаток</th>
            <th style="width:3ch;"></th>
          </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr>
            <td class="fw-semibold">
              {{ r.name }}
              {% if r.name == 'Ипотека' and (r.fixed_rub or 0) < 40000 %}<span title="Меньше 40 000 ₽">⚠</span>{% endif %}
            </td>

            <!-- Источник -->
            <td>
              <form hx-post="/category/update-min" hx-target="#table-wrap" hx-swap="outerHTML">
                <input type="hidden" name="id" value="{{ r.id }}">
                <input type="hidden" name="m" value="{{ ym }}">
                <input type="hidden" name="percent" value="{{ r.percent or '' }}">
                <input type="hidden" name="fixed" value="{{ r.fixed_rub or '' }}">
                <select class="form-select form-select-sm" name="source" onchange="this.form.submit()">
                  {% for s in sources %}
                    <option value="{{ s }}" {% if s == r.source %}selected{% endif %}>{{ s }}</option>
                  {% endfor %}
                </select>
              </form>
            </td>

            <!-- ₽ фикс -->
            <td>
              <form hx-post="/category/update-min" hx-target="#table-wrap" hx-swap="outerHTML"
                    hx-trigger="change, keyup delay:300ms from:input">
                <input type="hidden" name="id" value="{{ r.id }}">
                <input type="hidden" name="m" value="{{ ym }}">
                <input type="hidden" name="source" value="{{ r.source }}">
                <input class="form-control form-control-sm text-end" style="width:10ch"
                       type="number" step="0.01" name="fixed" value="{{ r.fixed_rub or '' }}">
                <input type="hidden" name="percent" value="{{ r.percent or '' }}">
              </form>
            </td>

            <!-- % -->
            <td>
              <form hx-post="/category/update-min" hx-target="#table-wrap" hx-swap="outerHTML"
                    hx-trigger="change, keyup delay:300ms from:input">
                <input type="hidden" name="id" value="{{ r.id }}">
                <input type="hidden" name="m" value="{{ ym }}">
                <input type="hidden" name="source" value="{{ r.source }}">
                <input class="form-control form-control-sm text-end" style="width:7ch"
                       type="number" step="0.01" name="percent" value="{{ r.percent or '' }}">
                <input type="hidden" name="fixed" value="{{ r.fixed_rub or '' }}">
              </form>
            </td>

            <td class="num">{{ "%.0f"|format(r.plan) }} ₽</td>
            <td class="num {% if r.spent>r.plan %}text-danger{% endif %}">{{ "%.0f"|format(r.spent) }} ₽</td>
            <td class="num fw-semibold {% if r.left>0 %}text-success{% endif %}">{{ "%.0f"|format(r.left) }} ₽</td>

            <td class="text-center">
              <form hx-post="/category/delete-min" hx-target="#table-wrap" hx-swap="outerHTML">
                <input type="hidden" name="id" value="{{ r.id }}">
                <input type="hidden" name="m" value="{{ ym }}">
                <button class="btn btn-sm btn-outline-danger" title="Удалить">×</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        {% if not rows %}
          <tr><td colspan="8" class="text-center text-secondary py-4">Категорий пока нет</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>