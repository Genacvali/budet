<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Категории ({{ ym }})</div>
      <div class="text-secondary small">Итого план: <span class="num">{{ "%.0f"|format(summary.total_plan) }}</span> ₽ ·
        Факт: <span class="num">{{ "%.0f"|format(summary.total_minus) }}</span> ₽ ·
        Остаток: <span class="num">{{ "%.0f"|format(summary.total_left) }}</span> ₽
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-dark">
          <tr>
            <th>Категория</th><th>Источник</th><th>%</th><th>₽ фикс</th>
            <th>План</th><th>Минусы</th><th>Остаток</th><th>Факт %</th>
            <th></th>
          </tr>
        </thead>
        <tbody x-data>
          {% for r in rows %}
          <tr x-data="rowCalc({ base: {{ summary.base.get(r.source,0) }}, percent: {{ r.percent or 'null' }}, fixed: {{ r.fixed_rub or 'null' }} })">
            <td class="fw-semibold">{{ r.name }}</td>
            <td class="text-secondary">{{ r.source }}</td>
            <td style="width:8ch">
              <input class="form-control form-control-sm text-end"
                     x-model.number="percent" x-on:input="syncPercent"
                     type="number" step="0.01" placeholder="%" />
            </td>
            <td style="width:12ch">
              <input class="form-control form-control-sm text-end"
                     x-model.number="fixed" x-on:input="syncFixed"
                     type="number" step="0.01" placeholder="₽" />
            </td>
            <td class="num">{{ "%.0f"|format(r.plan) }} ₽</td>
            <td class="num {% if r.spent>r.plan %}text-danger{% endif %}">{{ "%.0f"|format(r.spent) }} ₽</td>
            <td class="num fw-semibold">{{ "%.0f"|format(r.left) }} ₽</td>
            <td class="num">{% if r.fact_pct is not none %}{{ "%.2f"|format(r.fact_pct*100) }}%{% endif %}</td>
            <td>
              <form method="post" action="/category/update" hx-post="/category/update" hx-target="#table-wrap" hx-swap="outerHTML" class="d-flex gap-1">
                <input type="hidden" name="id" value="{{ r.id }}">
                <input type="hidden" name="m" value="{{ ym }}">
                <input type="hidden" name="percent" :value="percent ?? ''">
                <input type="hidden" name="fixed" :value="fixed ?? ''">
                <button class="btn btn-sm btn-outline-primary">Сохранить</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>