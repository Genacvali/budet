{% extends "base.html" %}
{% block content %}

<div class="d-flex flex-wrap align-items-end gap-2 mb-3">
  <div>
    <label class="form-label mb-1">Месяц</label>
    <div class="d-flex gap-2">
      <input id="m" class="form-control" style="max-width:200px" type="month" value="{{ ym }}">
      <button class="btn btn-primary" onclick="reloadTable()">Показать</button>
    </div>
  </div>

  <div class="ms-auto d-flex gap-2">
    <button class="btn btn-outline-success" onclick="addIncome()">+ Доход</button>
    <button class="btn btn-primary" onclick="addCategory()">+ Категория</button>
  </div>
</div>

<div id="table-wrap"
     hx-get="/partials/table-clean?m={{ ym }}"
     hx-trigger="load"
     hx-swap="outerHTML">
  <div class="text-secondary">Загрузка…</div>
</div>

<script>
async function reloadTable(){
  const m = document.getElementById('m').value;
  const el = document.getElementById('table-wrap');
  el.setAttribute('hx-get', `/partials/table-clean?m=${encodeURIComponent(m)}`);
  el.dispatchEvent(new Event('load'));
}

async function addIncome(){
  const m = document.getElementById('m').value;
  const dt = prompt("Дата (YYYY-MM-DD):", m+"-05");
  const source = prompt("Источник (ЗП/Аванс/Декретные):", "ЗП");
  const amount = prompt("Сумма, ₽:", "");
  if (!dt || !amount) return;
  const form = new FormData();
  form.append("m", m); form.append("dt", dt); form.append("source", source); form.append("amount", amount);
  await fetch("/income/add-min", { method: "POST", body: form }).then(()=>reloadTable());
}

async function addCategory(){
  const m = document.getElementById('m').value;
  const name = prompt("Название категории:");
  if (!name) return;
  const form = new FormData();
  form.append("m", m); form.append("name", name);
  await fetch("/category/add-clean", { method: "POST", body: form }).then(()=>reloadTable());
}
</script>
{% endblock %}